name: Metastore CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:
    inputs:
      run_integration:
        description: "Run integration tests (requires credentials)"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true

jobs:
  local-tests:
    name: Local Tests (no credentials required)
    runs-on: ubuntu-latest
    env:
      VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
      VCPKG_TARGET_TRIPLET: x64-linux
      GEN: ninja
    defaults:
      run:
        shell: bash

    steps:
      - name: Install Ninja
        run: sudo apt-get update -y -qq && sudo apt-get install -y -qq ninja-build

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: "true"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.1
        with:
          vcpkgGitCommitId: ce613c41372b23b1f51333815feb3edd87ef8a8b

      - name: Build extension
        run: make

      - name: Run SQLLogic tests (generic metastore contracts)
        run: make test

  integration-tests:
    name: Integration Tests (credential-gated)
    runs-on: ubuntu-latest
    env:
      VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
      VCPKG_TARGET_TRIPLET: x64-linux
      GEN: ninja
    defaults:
      run:
        shell: bash

    steps:
      - name: Check integration flag
        id: check_flag
        run: |
          if [ "${METASTORE_INTEGRATION_ENABLED}" = "true" ] || [ "${{ github.event.inputs.run_integration }}" = "true" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "Skipping: METASTORE_INTEGRATION_ENABLED not set"
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          METASTORE_INTEGRATION_ENABLED: ${{ vars.METASTORE_INTEGRATION_ENABLED }}

      - name: Install Ninja
        if: steps.check_flag.outputs.enabled == 'true'
        run: sudo apt-get update -y -qq && sudo apt-get install -y -qq ninja-build

      - uses: actions/checkout@v4
        if: steps.check_flag.outputs.enabled == 'true'
        with:
          fetch-depth: 0
          submodules: "true"

      - name: Setup vcpkg
        if: steps.check_flag.outputs.enabled == 'true'
        uses: lukka/run-vcpkg@v11.1
        with:
          vcpkgGitCommitId: ce613c41372b23b1f51333815feb3edd87ef8a8b

      - name: Build extension
        if: steps.check_flag.outputs.enabled == 'true'
        run: make

      - name: Run integration tests
        if: steps.check_flag.outputs.enabled == 'true'
        run: |
          chmod +x scripts/run_hms_integration.sh
          ./scripts/run_hms_integration.sh
        env:
          # HMS credentials (populated via GitHub Actions secrets)
          HMS_ENDPOINT: ${{ secrets.HMS_ENDPOINT }}
          # Glue credentials
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          # Dataproc credentials
          DATAPROC_ENDPOINT: ${{ secrets.DATAPROC_ENDPOINT }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      - name: Skip notice
        if: steps.check_flag.outputs.enabled == 'false'
        run: |
          echo "Skipping: METASTORE_INTEGRATION_ENABLED not set"
          echo "To run integration tests, set the METASTORE_INTEGRATION_ENABLED repository variable to 'true'"
          echo "or trigger this workflow manually with run_integration=true"
          exit 0
