name: Metastore CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true

jobs:
  local-tests:
    name: Local Tests (no credentials required)
    runs-on: ubuntu-latest
    env:
      VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
      VCPKG_TARGET_TRIPLET: x64-linux
      GEN: ninja
      HMS_SHARED_DIR: ${{ github.workspace }}/build/hms_shared
      HMS_LOCAL_ENDPOINT: 127.0.0.1:9083
    defaults:
      run:
        shell: bash

    steps:
      - name: Install Ninja
        run: sudo apt-get update -y -qq && sudo apt-get install -y -qq ninja-build netcat-openbsd

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: "true"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.1
        with:
          vcpkgGitCommitId: ce613c41372b23b1f51333815feb3edd87ef8a8b

      - name: Build extension
        run: make

      - name: Start HMS instance
        run: |
          mkdir -p "${HMS_SHARED_DIR}"
          chmod -R 0777 "${HMS_SHARED_DIR}"
          docker compose -f test/integration/hms/docker-compose.yml up -d
          for i in $(seq 1 60); do
            if nc -z 127.0.0.1 9083; then
              echo "HMS metastore reachable at 127.0.0.1:9083"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "Timed out waiting for HMS metastore on 127.0.0.1:9083" >&2
              docker compose -f test/integration/hms/docker-compose.yml ps >&2 || true
              docker compose -f test/integration/hms/docker-compose.yml logs --no-color >&2 || true
              exit 1
            fi
            sleep 2
          done

          for i in $(seq 1 60); do
            if docker compose -f test/integration/hms/docker-compose.yml exec -T hms-hiveserver2 \
              bash -lc "/opt/hive/bin/beeline -u 'jdbc:hive2://127.0.0.1:10000/default' -n hive -e 'SHOW DATABASES;' >/tmp/hms_ready.log 2>&1"; then
              echo "HiveServer2 ready"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "Timed out waiting for HiveServer2 readiness" >&2
              docker compose -f test/integration/hms/docker-compose.yml logs --no-color >&2 || true
              exit 1
            fi
            sleep 2
          done

      - name: Seed database data
        run: | 
          chmod +x test/integration/hms/create-hms-tables.sh
          ./test/integration/hms/create-hms-tables.sh

      - name: Run SQLLogic tests (host-local metastore contracts)
        run: ./build/release/test/unittest "test/sql/metastore/*"
        env:
          HMS_LOCAL_ENDPOINT: 127.0.0.1:9083

      - name: Stop Mock HMS Docker Compose
        if: always()
        run: docker compose -f test/integration/hms/docker-compose.yml down
